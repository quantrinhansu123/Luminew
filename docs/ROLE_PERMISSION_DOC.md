# Tài Liệu Về Role và Permission

## Tổng Quan

Hệ thống sử dụng Role-Based Access Control (RBAC) để quản lý quyền truy cập. Mỗi người dùng được gán một role, và role đó quyết định các quyền truy cập của họ.

## Cấu Trúc Database

### 1. Bảng `app_roles`
Định nghĩa các role trong hệ thống.

```sql
CREATE TABLE IF NOT EXISTS app_roles (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    code TEXT UNIQUE NOT NULL,           -- Mã role (VD: 'ADMIN', 'MKT_LEADER')
    name TEXT NOT NULL,                  -- Tên role (VD: 'Quản trị viên')
    department TEXT,                     -- Bộ phận (VD: 'Marketing', 'Sales')
    description TEXT,                    -- Mô tả
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2. Bảng `users`
Lưu thông tin người dùng và role của họ.

```sql
-- Cột quan trọng:
role TEXT,        -- Mã role (tham chiếu app_roles.code)
team TEXT,        -- Team của người dùng
email TEXT,       -- Email (dùng để đăng nhập)
```

### 3. Bảng `app_page_permissions`
Định nghĩa quyền truy cập cho từng role trên từng trang/module.

```sql
CREATE TABLE IF NOT EXISTS app_page_permissions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    role_code TEXT REFERENCES app_roles(code) ON DELETE CASCADE,
    page_code TEXT NOT NULL,             -- Mã trang/module (VD: 'MKT_VIEW', 'SALE_NEW_ORDER')
    
    -- Permissions Flags
    can_view BOOLEAN DEFAULT FALSE,      -- Quyền xem
    can_edit BOOLEAN DEFAULT FALSE,       -- Quyền sửa
    can_delete BOOLEAN DEFAULT FALSE,    -- Quyền xóa
    
    -- Column Level Security
    allowed_columns JSONB DEFAULT '["*"]'::jsonb,  -- Danh sách cột được phép xem
    
    UNIQUE(role_code, page_code)
);
```

## Các Role Chính

### 1. ADMIN (Quản trị viên)
- **Mã**: `ADMIN`
- **Quyền**: Toàn quyền hệ thống
- **Bypass**: Tự động có quyền truy cập tất cả trang và cột
- **Sử dụng**: Quản lý hệ thống, cấu hình, phân quyền

### 2. DIRECTOR (Giám đốc)
- **Mã**: `DIRECTOR`
- **Quyền**: Xem tất cả báo cáo
- **Sử dụng**: Xem tổng quan toàn bộ hệ thống

### 3. MANAGER (Quản lý)
- **Mã**: `MANAGER`
- **Quyền**: Quản lý team của mình
- **Sử dụng**: Quản lý nhân viên trong team

### 4. LEADER (Trưởng nhóm)
- **Mã**: `LEADER`
- **Quyền**: Quản lý team cụ thể
- **Sử dụng**: 
  - Xem dữ liệu của team mình
  - Quản lý nhân viên trong team
  - Xem báo cáo team

### 5. MKT_LEADER (Trưởng nhóm Marketing)
- **Mã**: `MKT_LEADER`
- **Bộ phận**: Marketing
- **Quyền**: Quản lý bộ phận Marketing

### 6. SALE_MEMBER (Nhân viên Sale)
- **Mã**: `SALE_MEMBER`
- **Bộ phận**: Sales
- **Quyền**: Chỉ xem đơn của mình

### 7. ORDERS_MEMBER (Nhân viên Vận Đơn)
- **Mã**: `ORDERS_MEMBER`
- **Bộ phận**: Vận Đơn
- **Quyền**: Xử lý đơn hàng vận đơn

### 8. CSKH Staff (Nhân viên CSKH)
- **Mã**: `CSKH` (trong department)
- **Bộ phận**: CSKH
- **Quyền**: Chăm sóc khách hàng, xem đơn được phân bổ

## Các Page Code Phổ Biến

### Module Marketing
- `MKT_VIEW`: Xem báo cáo Marketing
- `MKT_INPUT`: Nhập báo cáo Marketing
- `MKT_MANUAL`: Quản lý báo cáo tay Marketing
- `MKT_PAGES`: Quản lý Pages Marketing
- `RND_VIEW`: Xem báo cáo R&D
- `RND_INPUT`: Nhập báo cáo R&D
- `RND_MANUAL`: Quản lý báo cáo tay R&D
- `RND_PAGES`: Quản lý Pages R&D
- `RND_NEW_ORDER`: Tạo đơn hàng R&D

### Module Sale
- `SALE_NEW_ORDER`: Tạo đơn hàng mới
- `SALE_VIEW`: Xem đơn hàng

### Module CSKH
- `CSKH_NEW_ORDER`: Tạo đơn hàng CSKH
- `CSKH_PAID`: Xem đơn đã thanh toán
- `CSKH_VIEW`: Xem dữ liệu CSKH

### Module Orders
- `ORDERS_NEW`: Tạo đơn hàng mới
- `ORDERS_VIEW`: Xem đơn hàng
- `ORDERS_EDIT`: Sửa đơn hàng

## Hook usePermissions

### Import
```javascript
import { usePermissions } from '../hooks/usePermissions';
```

### Sử dụng
```javascript
const { 
    role,           // Role hiện tại (VD: 'ADMIN', 'LEADER')
    team,           // Team hiện tại (VD: 'HCM', 'Hà Nội')
    loading,        // Trạng thái loading
    canView,        // Hàm kiểm tra quyền xem
    canEdit,        // Hàm kiểm tra quyền sửa
    canDelete,      // Hàm kiểm tra quyền xóa
    getAllowedColumns,  // Lấy danh sách cột được phép
    isColumnAllowed,    // Kiểm tra cột có được phép không
    refreshPermissions  // Làm mới permissions
} = usePermissions();
```

### Ví dụ sử dụng

#### Kiểm tra quyền xem trang
```javascript
const { canView } = usePermissions();

if (!canView('MKT_VIEW')) {
    return <div>Bạn không có quyền truy cập</div>;
}
```

#### Kiểm tra quyền sửa
```javascript
const { canEdit } = usePermissions();

{canEdit('ORDERS_EDIT') && (
    <button onClick={handleEdit}>Sửa</button>
)}
```

#### Kiểm tra role
```javascript
const { role } = usePermissions();

const isAdmin = role === 'ADMIN';
const isLeader = role === 'LEADER';
```

#### Kiểm tra cột được phép
```javascript
const { isColumnAllowed } = usePermissions();

{isColumnAllowed('ORDERS_VIEW', 'total_amount_vnd') && (
    <td>{order.total_amount_vnd}</td>
)}
```

## Logic Phân Quyền

### 1. Admin Bypass
```javascript
if (role === 'ADMIN') {
    return true; // Admin có quyền tất cả
}
```

### 2. Leader Filter
```javascript
if (role === 'LEADER' && team) {
    // Chỉ xem dữ liệu của team mình
    query = query.eq('team', team);
}
```

### 3. Staff Filter
```javascript
if (role === 'STAFF') {
    // Chỉ xem dữ liệu của chính mình
    const userName = localStorage.getItem('username');
    query = query.ilike('marketing_staff', userName);
}
```

## Cấu Hình Permission

### Thêm Role Mới
```sql
INSERT INTO app_roles (code, name, department, description)
VALUES ('NEW_ROLE', 'Tên Role', 'Department', 'Mô tả');
```

### Gán Permission cho Role
```sql
INSERT INTO app_page_permissions (role_code, page_code, can_view, can_edit, can_delete, allowed_columns)
VALUES ('NEW_ROLE', 'MKT_VIEW', true, false, false, '["*"]'::jsonb);
```

### Gán Role cho User
```sql
UPDATE users
SET role = 'NEW_ROLE'
WHERE email = 'user@example.com';
```

## Best Practices

1. **Luôn kiểm tra quyền trước khi hiển thị**: Sử dụng `canView()` để kiểm tra trước khi render component
2. **Sử dụng role để filter dữ liệu**: Filter dữ liệu ở database level, không chỉ ở UI
3. **Cache permissions**: Hook `usePermissions` đã có cache, không cần fetch lại nhiều lần
4. **Column-level security**: Sử dụng `isColumnAllowed()` để ẩn các cột nhạy cảm
5. **Admin bypass**: Luôn kiểm tra `role === 'ADMIN'` để bypass tất cả kiểm tra

## Troubleshooting

### User không có quyền truy cập
1. Kiểm tra `users.role` có được set chưa
2. Kiểm tra `app_page_permissions` có entry cho role đó chưa
3. Kiểm tra `can_view = true` trong permission entry

### Permission không cập nhật
1. Gọi `refreshPermissions()` để làm mới cache
2. Kiểm tra cache duration (mặc định 1 phút)
3. Đảm bảo email trong localStorage khớp với database

### Column không hiển thị
1. Kiểm tra `allowed_columns` trong `app_page_permissions`
2. Sử dụng `isColumnAllowed()` để kiểm tra
3. Admin luôn thấy tất cả cột (`['*']`)

## Tài Liệu Tham Khảo

- File code: `src/hooks/usePermissions.js`
- Database schema: `supabase_scripts/seed_roles.sql`
- Permission matrix: `supabase_scripts/create_page_permissions_table.sql`
